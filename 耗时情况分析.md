# 📊 DroidRun 性能对比分析报告

## 执行摘要

本报告对比分析了 DroidRun 系统在**冷启动**和**热启动（完美匹配）**两种模式下的性能表现。通过详细的性能日志追踪，我们识别了主要的性能瓶颈并量化了优化效果。

任务命令：“进入请休假系统，提交2025年11月24日到2025年11月25日的年休假申请。请假事由：出去玩，拟前往地区：北京。请尝试完成整个流程，包括登录（如果需要的话）和提交申请。”

---

## 1. 总体性能对比

### **关键指标**

| 指标             | 冷启动 | 热启动          | 提升        |
| ---------------- | ------ | --------------- | ----------- |
| **总耗时**       | 84.63s | 12.80s          | **84.9%** ⬇️ |
| **LLM 调用次数** | 10次   | 2次             | **80.0%** ⬇️ |
| **执行步骤**     | 9步    | 0步（直接执行） | **100%** ⬇️  |
| **动作数量**     | 10个   | 10个            | 相同        |

### **性能提升可视化**

```
冷启动：████████████████████████████████████████████ 84.63s
热启动：██████ 12.80s
提升：  ██████████████████████████████████████ 84.9%
```

---

## 2. 详细耗时分解

### **2.1 冷启动（84.63秒）**

#### **阶段性耗时**

| 阶段                | 耗时   | 占比  | 说明               |
| ------------------- | ------ | ----- | ------------------ |
| **任务类型判断**    | 1.38s  | 1.6%  | LLM 判断任务类型   |
| **经验检索**        | 0.00s  | 0.0%  | 无相似经验         |
| **LLM 思考（9步）** | 71.04s | 84.0% | ⚠️ **最大瓶颈**     |
| **移动端操作**      | 3.55s  | 4.2%  | 实际操作耗时       |
| **UI 捕获**         | 2.97s  | 3.5%  | get_state 操作     |
| **其他开销**        | 5.69s  | 6.7%  | 初始化、轨迹保存等 |

#### **LLM 思考详细耗时**

| Step     | LLM 耗时   | get_state | 移动端操作 | 操作内容             |
| -------- | ---------- | --------- | ---------- | -------------------- |
| 1        | 10.07s     | 0.26s     | 0.43s      | tap(29) 进入请休假   |
| 2        | 5.99s      | 0.37s     | 0.20s      | tap(12) 选择年休假   |
| 3        | 10.83s     | 0.61s     | 0.30s      | tap(22) 修改结束时间 |
| 4        | 7.88s      | 0.26s     | 0.22s      | tap(82) 选择25日     |
| 5        | 8.38s      | 0.22s     | 0.39s      | tap(35) 确认时间     |
| 6        | 5.33s      | 0.41s     | 1.17s      | input × 2 填写信息   |
| 7        | 7.52s      | 0.09s     | 0.23s      | tap(31) 提交申请     |
| 8        | 10.00s     | 0.23s     | 0.29s      | tap(39) 确认提交     |
| 9        | 11.18s     | 0.31s     | 0.43s      | tap(39) 关闭成功提示 |
| **总计** | **71.04s** | **2.97s** | **3.55s**  | -                    |

**LLM 平均耗时**：7.89秒/步

---

### **2.2 热启动（12.80秒）**

#### **阶段性耗时**

| 阶段             | 耗时  | 占比  | 说明               |
| ---------------- | ----- | ----- | ------------------ |
| **任务类型判断** | 0.96s | 7.5%  | LLM 判断任务类型   |
| **经验检索**     | 1.32s | 10.3% | 找到完美匹配       |
| **参数适配**     | 0.00s | 0.0%  | ✅ 跳过（完美匹配） |
| **变更检测**     | 0.00s | 0.0%  | ✅ 跳过（完美匹配） |
| **初始化 UI**    | 0.17s | 1.3%  | 获取初始状态       |
| **动作重构**     | 0.00s | 0.0%  | 无需重构           |
| **动作循环**     | 9.90s | 77.3% | 执行10个动作       |
| **其他开销**     | 0.45s | 3.5%  | 轨迹记录等         |

#### **动作循环详细耗时**

| 动作     | 类型  | tap/input | wait      | capture   | 总计      | 操作内容     |
| -------- | ----- | --------- | --------- | --------- | --------- | ------------ |
| 1        | tap   | 0.33s     | 0.30s     | 0.25s     | 0.88s     | 进入请休假   |
| 2        | tap   | 0.19s     | 0.30s     | 0.34s     | 0.83s     | 选择年休假   |
| 3        | tap   | 0.18s     | 0.30s     | 0.22s     | 0.70s     | 修改结束时间 |
| 4        | tap   | 0.21s     | 0.30s     | 0.20s     | 0.71s     | 选择25日     |
| 5        | tap   | 0.31s     | 0.30s     | 0.26s     | 0.88s     | 确认时间     |
| 6        | input | 0.52s     | 0.20s     | 0.22s     | 0.95s     | 填写事由     |
| 7        | input | 0.52s     | 0.20s     | 0.10s     | 0.82s     | 填写地区     |
| 8        | tap   | 0.19s     | 0.30s     | 0.26s     | 0.75s     | 提交申请     |
| 9        | tap   | 0.21s     | 0.30s     | 0.14s     | 0.66s     | 确认提交     |
| 10       | tap   | 0.26s     | 0.30s     | 0.36s     | 0.92s     | 关闭提示     |
| **总计** | -     | **2.92s** | **2.80s** | **2.35s** | **9.90s** | -            |

**统计**：
- **移动端操作**：2.92秒（29.5%）
- **等待时间**：2.80秒（28.3%）
- **UI 捕获**：2.35秒（23.7%）
- **其他开销**：1.83秒（18.5%）

---

## 3. 性能瓶颈分析

### **3.1 冷启动的主要瓶颈**

#### **🔴 LLM 思考时间（71.04秒，占84%）**

**问题**：
- 每步都需要 LLM 分析 UI 状态并决策
- 平均每步耗时 7.89秒
- 最长一步：11.18秒（Step 9）
- 最短一步：5.33秒（Step 6）

**影响因素**：
1. **UI 状态复杂度**：a11y_tree 包含大量元素
2. **LLM 模型速度**：使用 qwen-plus（较慢但准确）
3. **网络延迟**：API 调用延迟
4. **Prompt 长度**：包含完整 UI 状态和历史对话

**优化建议**：
- ✅ 使用热启动（已实现，效果显著）
- 🔄 使用更快的模型（qwen-turbo）用于简单任务
- 🔄 优化 Prompt，减少不必要的 UI 信息
- 🔄 启用流式输出，提前开始执行

---

### **3.2 热启动的主要瓶颈**

#### **🟡 等待时间（2.80秒，占28.3%）**

**当前配置**：
```yaml
screenshot_wait_time: 0.30s  # tap 后等待
action_wait_time: 0.20s      # input 后等待
```

**耗时分解**：
- 8个 tap × 0.30s = 2.40s
- 2个 input × 0.20s = 0.40s
- 总计：2.80s

**优化潜力**：
- 减少到 0.20s（tap）和 0.10s（input）
- 预期节省：~1.5秒

#### **🟡 UI 捕获时间（2.35秒，占23.7%）**

**问题**：
- 每个动作后都捕获 UI（10次）
- 平均每次 0.24秒

**优化建议**：
- 热启动时减少捕获频率（如每2-3个动作捕获一次）
- 预期节省：~1.0秒

#### **🟡 其他开销（1.83秒，占18.5%）**

**可能来源**：
- 动作间的额外处理
- 轨迹记录和事件写入
- 事件循环阻塞

---

## 4. 对比分析

### **4.1 LLM 调用对比**

| 场景       | LLM 调用次数 | 总耗时 | 平均耗时 |
| ---------- | ------------ | ------ | -------- |
| **冷启动** | 10次         | 72.42s | 7.24s/次 |
| **热启动** | 2次          | 2.28s  | 1.14s/次 |
| **节省**   | 8次          | 70.14s | -        |

**说明**：
- 冷启动：1次任务类型判断 + 9次步骤思考
- 热启动：1次任务类型判断 + 1次经验检索

### **4.2 移动端操作对比**

| 场景       | 操作耗时 | 等待时间 | UI 捕获 | 总计  |
| ---------- | -------- | -------- | ------- | ----- |
| **冷启动** | 3.55s    | -        | 2.97s   | 6.52s |
| **热启动** | 2.92s    | 2.80s    | 2.35s   | 8.07s |

**说明**：
- 冷启动的移动端操作更慢（可能因为 LLM 思考时 UI 已稳定）
- 热启动增加了显式等待时间（优化后的配置）

### **4.3 效率提升**

```
┌─────────────────────────────────────────────────────────┐
│ 冷启动（84.63秒）                                        │
├─────────────────────────────────────────────────────────┤
│ LLM 思考        71.04s  ████████████████████████████████│
│ 移动端操作      3.55s   ███                             │
│ UI 捕获         2.97s   ██                              │
│ 其他            7.07s   ████                            │
└─────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────┐
│ 热启动（12.80秒）                                        │
├─────────────────────────────────────────────────────────┤
│ 动作循环        9.90s   ████████████████████████████████│
│ 经验检索        1.32s   ████                            │
│ 任务类型判断    0.96s   ███                             │
│ 其他            0.62s   ██                              │
└─────────────────────────────────────────────────────────┘
```

---

## 5. 优化建议与预期效果

### **5.1 短期优化（立即可实施）**

#### **优化 1：进一步减少等待时间**

**当前配置**：
```yaml
screenshot_wait_time: 0.30s
action_wait_time: 0.20s
```

**优化配置**：
```yaml
screenshot_wait_time: 0.20s  # 减少 0.10s
action_wait_time: 0.10s      # 减少 0.10s
```

**预期效果**：
- 节省：8 × 0.10s + 2 × 0.10s = 1.00s
- 优化后：12.80s → 11.80s
- 提升：7.8%

#### **优化 2：减少 UI 捕获频率**

**方案**：热启动时每2个动作捕获一次

**预期效果**：
- 减少 5次捕获 × 0.24s = 1.20s
- 优化后：11.80s → 10.60s
- 提升：17.2%

---

### **5.2 中期优化（需要开发）**

#### **优化 3：智能等待机制**

**方案**：根据操作类型和 UI 变化动态调整等待时间

**预期效果**：
- 节省：~1.5秒
- 优化后：10.60s → 9.10s

#### **优化 4：并行化操作**

**方案**：某些操作可以并行执行（如 UI 捕获和下一个动作准备）

**预期效果**：
- 节省：~0.5秒
- 优化后：9.10s → 8.60s

---

### **5.3 长期优化（架构级）**

#### **优化 5：冷启动使用 qwen-turbo**

**方案**：对于简单任务使用更快的模型

**预期效果**：
- LLM 耗时减半：71.04s → 35.52s
- 总耗时：84.63s → 49.11s
- 提升：42.0%

#### **优化 6：混合模式**

**方案**：部分步骤使用热启动，部分使用冷启动

**预期效果**：
- 灵活性提升
- 平均耗时：20-30秒

---

## 6. 综合评估

### **6.1 热启动的优势**

| 指标         | 优势                      |
| ------------ | ------------------------- |
| **速度**     | 比冷启动快 **84.9%**      |
| **稳定性**   | 直接执行，无 LLM 不确定性 |
| **成本**     | LLM 调用减少 **80%**      |
| **可预测性** | 耗时稳定在 12-15秒        |

### **6.2 冷启动的价值**

| 指标         | 价值             |
| ------------ | ---------------- |
| **灵活性**   | 可处理任何新任务 |
| **适应性**   | 能应对 UI 变化   |
| **学习能力** | 生成新的经验数据 |
| **通用性**   | 无需历史经验     |

### **6.3 最终优化目标**

```
当前热启动：12.80秒
短期优化后：10.60秒（减少等待 + 减少捕获）
中期优化后：8.60秒（智能等待 + 并行化）
长期目标：<8秒（接近理论极限）

理论极限计算：
- 移动端操作：2.92s（不可压缩）
- 任务类型判断：0.96s（必需）
- 经验检索：1.32s（必需）
- 最小等待：1.00s（保证稳定性）
- 最小捕获：1.00s（关键步骤）
理论极限 = 7.20秒
```

---

## 7. 结论

### **主要发现**

1. ✅ **热启动效果显著**：相比冷启动提升 **84.9%**
2. ✅ **完美匹配优势明显**：跳过参数适配和变更检测
3. ⚠️ **等待时间仍可优化**：占热启动耗时的 28.3%
4. ⚠️ **UI 捕获频率可降低**：占热启动耗时的 23.7%
5. 🔴 **冷启动 LLM 是瓶颈**：占总耗时的 84.0%

### **推荐行动**

**立即实施**：
1. 减少等待时间配置（预期节省 1.0秒）
2. 优化 UI 捕获频率（预期节省 1.2秒）

**短期计划**：
3. 实现智能等待机制（预期节省 1.5秒）
4. 并行化部分操作（预期节省 0.5秒）

**长期规划**：
5. 冷启动使用 qwen-turbo（预期提升 42%）
6. 实现混合模式（平衡速度和灵活性）

### **最终目标**

```
热启动目标：<8秒（接近理论极限）
冷启动目标：<50秒（使用更快模型）
平均耗时目标：<15秒（80%热启动 + 20%冷启动）
```

---

**报告生成时间**：2025-11-24  
**分析基准**：优化后配置（screenshot_wait_time=0.3s, action_wait_time=0.2s）  
**数据来源**：实际执行日志